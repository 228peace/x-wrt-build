#=================================================
#   Description: Build Custom X-WRT for 192.168.33.1
#   License: MIT
#   Author: ptpt52 (Customized by Gemini)
#=================================================

name: Custom X-WRT Build (x86_64)

on: 
  workflow_dispatch:  # 開啟手動觸發按鈕
  push:
    branches:
      - master
    paths:
      - 'custom_packages.config'
      - 'release.tag'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "Updating system and installing dependencies..."
        sudo -E apt-get update
        
        # 移除不必要的預裝軟體，釋放空間 (避免磁碟空間不足導致編譯失敗)
        sudo apt-get remove --purge -y \
          azure-cli \
          ghc* \
          zulu* \
          hhvm \
          llvm* \
          firefox \
          google* \
          dotnet* \
          powershell \
          openjdk* \
          mysql* \
          php* || true
        
        sudo apt-get clean
        sudo apt-get autoremove --purge -y
        sudo docker system prune -a -f --volumes || true
        
        # 安裝編譯依賴
        sudo -E apt-get -y install python3-pyelftools build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler

    - name: Clone X-WRT source code
      run: |
        TAG=$(cat release.tag)
        echo "Cloning X-WRT version: $TAG"
        # 移除 --depth 1 以確保 git describe 能正確識別 release commit
        git clone --branch $TAG https://github.com/x-wrt/x-wrt.git

    - name: Update & Install feeds
      run: |
        cd x-wrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Inject Custom Packages
      run: |
        # 僅注入自定義套件清單，不處理敏感設定檔 (files/)
        if [ -f "custom_packages.config" ]; then
          echo "Injecting custom packages..."
          cat custom_packages.config >> x-wrt/.config
        else
          echo "Warning: custom_packages.config not found."
        fi

    - name: Building Firmware
      run: |
        cp *.sh x-wrt/
        cp release.tag x-wrt/
        cd x-wrt
        echo -e "$(nproc) thread build."
        TARGET=x86_64 sh build.sh $(nproc)

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: x-wrt-custom-firmware
        path: x-wrt/rom/*.img.gz

    - name: Upload Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-failure-logs
        path: |
          x-wrt/logs/
          make.log